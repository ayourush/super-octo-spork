name: Production Deploy (OIDC + Dynamic Inventory + Split Roles)

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-north-1

      - name: Fetch Infrastructure Data
        id: fetch_data
        run: |
          MOTIVATOR_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Motivator-Server" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text | tr -s '[:space:]' ' ')
          
          MEMER_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=Memer-Server" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].PublicIpAddress" \
            --output text | tr -s '[:space:]' ' ')

          RDS=$(aws rds describe-db-instances \
            --db-instance-identifier bot-db \
            --query "DBInstances[0].Endpoint.Address" \
            --output text | tr -d '\n')

          echo "motivator_ip=$MOTIVATOR_IP" >> $GITHUB_OUTPUT
          echo "memer_ip=$MEMER_IP" >> $GITHUB_OUTPUT          
          echo "rds_host=$RDS" >> $GITHUB_OUTPUT

      - name: Whitelist Runner IP
        id: setup_firewall
        run: |
          MY_IP=$(curl -s https://checkip.amazonaws.com | tr -d '\n')
          echo "runner_ip=$MY_IP" >> $GITHUB_OUTPUT
          
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${MY_IP}/32 > /dev/null

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Run Ansible Playbook
        run: |
          echo "[motivator_group]" > inventory.ini
          echo "motivator-host ansible_host=${{ steps.fetch_data.outputs.motivator_ip }}" >> inventory.ini
          
          echo "[memer_group]" >> inventory.ini
          echo "memer-host ansible_host=${{ steps.fetch_data.outputs.memer_ip }}" >> inventory.ini
                    
          ansible-playbook -i inventory.ini ansible/deploy_docker_bots.yml \
            --extra-vars "db_host=${{ steps.fetch_data.outputs.rds_host }}" \
            --extra-vars "db_password=${{ secrets.DB_PASSWORD }}" \
            --extra-vars "motivator_token=${{ secrets.MOTIVATOR_TOKEN }}" \
            --extra-vars "memer_token=${{ secrets.MEMER_TOKEN }}" \
            --extra-vars "admin_id=${{ secrets.ADMIN_ID }}" \
            --user ubuntu

      - name: Revoke Runner IP
        if: always() && steps.setup_firewall.outcome == 'success'
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SG_ID }} \
            --protocol tcp --port 22 --cidr ${{ steps.setup_firewall.outputs.runner_ip }}/32 > /dev/null